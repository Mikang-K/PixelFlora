upstream backend_pool {
    server backend-a:3001;
    server backend-b:3001;
}

# Custom log format: shows which upstream handled each request
log_format lb_upstream '[$time_local] $remote_addr â†’ $upstream_addr "$request" $status';

server {
    listen 80;
    access_log /var/log/nginx/access.log lb_upstream;

    # WebSocket proxy for Socket.io (requires HTTP/1.1 + Upgrade header)
    location /socket.io/ {
        proxy_pass http://backend_pool;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400s;
    }

    # REST API proxy
    location /api/ {
        proxy_pass http://backend_pool;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Health check endpoint (ALB equivalent)
    location /health {
        proxy_pass http://backend_pool;
        proxy_set_header Host $host;
    }
}
